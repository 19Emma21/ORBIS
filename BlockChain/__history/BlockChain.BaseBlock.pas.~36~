unit BlockChain.BaseBlock;

interface

uses
  System.SysUtils,
  System.Hash,
  System.Classes,
  App.Types,
  Wallet.Types,
  BlockChain.Types,
  Crypto.RSA;

type
  TBaseBlock = class abstract
  protected
    Header: THeader;
  public
    function GetHeader: THeader;
    procedure SignBlock(AWallet: TWallet; APreviousHash: THash);// virtual; abstract;
    function GetSizeBlock: uint64; virtual; abstract;
    function GetData: TBytes; virtual; abstract;
    function GetDataWithoutHeader: TBytes; virtual; abstract;
    function GetHash: THash;
    procedure SetData(const AData: TBytes); virtual; abstract;
  end;

implementation

{ TBaseBlock }

function TBaseBlock.GetHash: THash;
begin
  Result := Header.CurrentHash;
end;

function TBaseBlock.GetHeader: THeader;
begin
  Result := Header;
end;

procedure TBaseBlock.SignBlock(AWallet: TWallet; APreviousHash: THash);
var
  Buf: TMemoryStream;
  data, body: TBytes;
begin
  body := GetDataWithoutHeader;
  Buf := TMemoryStream.Create;
  Buf.WriteData(APreviousHash + body, SizeOf(THash) + Length(body));
  Header.CurrentHash := THashSHA2.GetHashBytes(buf);
  Buf.Destroy;

  Buf := TMemoryStream.Create;
  Buf.WriteData(data, length(data));
  Buf.Position := 0;
  Header.Sign := RSAEncrypt(AWallet.PrivKey, Header.CurrentHash);
  Buf.Destroy;
end;

end.
